# -*- coding: utf-8 -*-
"""extrair_frames_1fps_colab.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16bCCyWEfYulK6NPwTOGhHoJFL6DnGHlF
"""

# Etapa 1: Upload do vÃ­deo
from google.colab import files
import os

uploaded = files.upload()

# Pega o nome do vÃ­deo enviado
video_filename = list(uploaded.keys())[0]
print(f"VÃ­deo recebido: {video_filename}")

# Etapa 2: Instala o OpenCV (caso ainda nÃ£o esteja instalado)
!pip install opencv-python-headless

# Etapa 3: FunÃ§Ã£o para extrair 1 frame por segundo
import cv2
import os
import time
import psutil

def extrair_frames_por_segundo(video_path, output_folder):
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    cap = cv2.VideoCapture(video_path)

    if not cap.isOpened():
        print(f"Erro ao abrir o vÃ­deo: {video_path}")
        return

    fps = cap.get(cv2.CAP_PROP_FPS)  # Frames por segundo do vÃ­deo
    frame_interval = int(fps)        # Pular para o prÃ³ximo segundo

    frame_count = 0
    saved_count = 0

    while True:
        ret, frame = cap.read()
        if not ret:
            break

        # Salva somente 1 frame por segundo
        if frame_count % frame_interval == 0:
            frame_filename = os.path.join(output_folder, f"frame_{saved_count:05d}.png")
            cv2.imwrite(frame_filename, frame)
            print(f"Salvando frame do segundo {saved_count}: {frame_filename}")
            saved_count += 1

        frame_count += 1

    cap.release()
    print(f"{saved_count} frames salvos (1 por segundo) em: '{output_folder}'")
    return saved_count

# Etapa 4: FunÃ§Ã£o para gerar KPIs
def gerar_kpis(video_path, pasta_frames, tempo_inicio, tempo_fim, frames_extraidos):
    # Calcula o tempo de processamento
    tempo_total = tempo_fim - tempo_inicio

    # Uso de memÃ³ria (em MB)
    processo = psutil.Process(os.getpid())
    memoria_usada = processo.memory_info().rss / (1024 * 1024)

    # Abre o vÃ­deo para pegar o total de frames
    cap = cv2.VideoCapture(video_path)
    fps_video = cap.get(cv2.CAP_PROP_FPS)
    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    cap.release()

    # Calcula o tamanho total dos frames extraÃ­dos
    arquivos = os.listdir(pasta_frames)
    total_tamanho = sum(os.path.getsize(os.path.join(pasta_frames, f)) for f in arquivos) / (1024 * 1024)  # em MB

    # Tamanho mÃ©dio por frame (em KB)
    tamanho_medio_frame = (total_tamanho * 1024) / len(arquivos)  # em KB

    # EficiÃªncia do processamento
    eficiencia = (frames_extraidos / total_frames) * 100

    # Velocidade de extraÃ§Ã£o (frames por segundo)
    velocidade_extracao = frames_extraidos / tempo_total if tempo_total > 0 else 0

    # Exibindo os KPIs
    print("\nKPIs do Processamento de VÃ­deo:")
    print(f"â±ï¸ Tempo de processamento total: {tempo_total:.2f} segundos")
    print(f"ğŸ§  Uso de memÃ³ria RAM: {memoria_usada:.2f} MB")
    print(f"ğŸ’¾ EspaÃ§o total dos frames extraÃ­dos: {total_tamanho:.2f} MB")
    print(f"ğŸ“ Tamanho mÃ©dio por frame: {tamanho_medio_frame:.2f} KB")
    print(f"ğŸ§© EficiÃªncia do processamento: {eficiencia:.2f}%")
    print(f"âš™ï¸ Velocidade de extraÃ§Ã£o: {velocidade_extracao:.2f} frames/s")


# Etapa 5: Executar o processo
output_folder = "frames_1fps"
tempo_inicio = time.time()
frames_extraidos = extrair_frames_por_segundo(video_filename, output_folder)
tempo_fim = time.time()

# Gerar KPIs apÃ³s a extraÃ§Ã£o dos frames
gerar_kpis(video_filename, output_folder, tempo_inicio, tempo_fim, frames_extraidos)

# Etapa 6: Compactar os frames para facilitar download
import shutil

shutil.make_archive("frames_extraidos", 'zip', output_folder)
files.download("frames_extraidos.zip")